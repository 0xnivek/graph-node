version: 2.1

jobs:
  unit_tests:
    docker:
      - image: rust
    environment:
      CARGO_TERM_COLOR: always
      RUST_BACKTRACE: full
      THEGRAPH_STORE_POSTGRES_DIESEL_URL: 'postgresql://localhost/graph-node?user=graph-node&password=let-me-in'
      GRAPH_MAX_SPEC_VERSION: '0.0.4'
    steps:
      - checkout
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.25.3/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
      - run:
          name: Docker dependencies
          command: cd docker && docker-compose up -d ipfs postgres
      # TODO: remove this and wait docker properly
      - run:
          name: Wait docker
          command: sleep 10
      - run:
          name: Run unit tests
          command: cargo test --no-fail-fast --verbose --workspace --exclude graph-tests -- --nocapture

  rustfmt:
    docker:
      - image: rust
    steps:
      - checkout
      - run:
          name: Install cargo fmt
          command: rustup component add rustfmt
      - run:
          name: Run Rust formatter
          command: cargo fmt --all -- --check

workflows:
  version: 2
  build_and_test:
    jobs:
      - rustfmt
      - unit_tests
